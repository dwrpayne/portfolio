{% extends "base.html" %}
{% load mytags %}
{% load static %}
{% block title %} {{ request.user.username }} {% endblock title %}
{% block content %}
    <div class="row">
        <div class="col-sm-8">{% include "finance/holdings.html" %}</div>
        <div class="col-sm-3">{% include "finance/balances.html" %}</div>
        <div class="col-sm-1">
            <br/><br/>
            <button type="submit" class="refresh" data-refresh-type="plot" data-refresh-div="history-plot;growth-plot">
                Refresh Graphs
            </button>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6" id="history-plot"></div>
        <div class="col-sm-6" id="growth-plot"></div>
    </div>
{% endblock content %}
{% block footer_javascript_page %}
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/stock/indicators/indicators.js"></script>
    <script>
    $.get("{% url 'finance:portfoliochart' %}", function(historydata) {
        Highcharts.StockChart({
            boost: {
                useGPUTranslations: true
            },
            chart: {
                renderTo: "history-plot",
                width: 700,
                height: 500,
                type: 'line',
                zoomType: 'xy'
            },
            credits: {
                enabled: false
            },
            data: {
                firstRowAsNames: false,
                rows: historydata
            },
            navigator: {
                enabled: false,
            },
            plotOptions: {
                series: {
                    tooltip: {
                        valueDecimals: 2,
                        valuePrefix: '$'
                    }
                }
            },
            series: [{
                name: 'Total Value',
                color: 'blue'
            }, {
                name: 'Total Contributions',
                color: 'orange',
                step: 'left'
            }, {
                name: 'Net Growth',
                color: 'lime',
                negativeColor: 'red'
            }],
            title: {
                text: 'Portfolio Value Over Time'
            },
            tooltip: {
                split: false,
                shared: true
            },
            xAxis: {
                type: 'datetime',
            },
            yAxis: {
                plotLines: [{
                    value: 0,
                    width: 2,
                    color: 'black'
                }]
            }
        });
    });
    $.get("{% url 'finance:growthchart' %}", function(growthdata) {
       Highcharts.StockChart({
           boost: {
               useGPUTranslations: true
           },
           chart: {
               renderTo: "growth-plot",
               width: 700,
               height: 500,
               type: 'scatter',
               zoomType: 'xy'
           },
           credits: {
               enabled: false
           },
           data: {
               firstRowAsNames: false,
               rows: growthdata
           },
           navigator: {
               enabled: false
           },
           plotOptions: {
               series: {
                   tooltip: {
                       valueDecimals: 2
                   }
               }
           },
           series: [{
                   type: 'scatter',
                   id: 'growth',
                   color: 'royalblue',
                   marker: {
                       radius: 2,
                       symbol: 'circle'
                   },
                   name: 'Daily growth',
                   tooltip: {
                       headerFormat: '<span style=\"font-size: 10px\">{point.key}</span><br/>',
                       pointFormatter: function() {
                           if (this.y >= 0) {
                               return "Gain: <b>$" + this.y + "</b>";
                           }
                           return "Loss: <b>$(" + Math.abs(this.y) + ")</b>";
                       }
                   }
               },
               {
                   type: 'sma',
                   color: 'lime',
                   name: '90 Day Average Daily Profit',
                   linkedTo: 'growth',
                   negativeColor: 'red',
                   params: {
                       period: 90
                   },
                   tooltip: {
                       pointFormat: '<span style="color:{point.color}">\u25cf</span> {series.name}: <b>${point.y:.2f}</b><br/>'
                   }
               }
           ],
           title: {
               text: 'Daily Gain/Loss'
           },
           tooltip: {
               split: false,
               shared: true
           },
           xAxis: {
               type: 'datetime'
           },
           yAxis: {
               plotLines: [{
                   value: 0,
                   width: 2,
                   color: 'black'
               }]
           }
       });
    });
    </script>
{% endblock footer_javascript_page %}
