{% extends "base.html" %}
{% load mytags %}
{% load static %}
{% block title %}Rebalancing Table{% endblock title %}

{% block head_css_page %}
    <style>
        .security {
            border: 1px solid #aaaaaa;
            border-radius: 5px;
            margin: 5px;
            padding: 5px;
            transition-duration: 0.3s;
            transition-property: background-color;
        }

        .security:hover {
            background: #afafaf;
            color: #dddddd;
        }

        .allocation {
            border: 2px solid #aaaaaa;
            margin: 5px;
            padding: 5px;
        }

        .allocation.validtarget {
            border-color: #50e7e9;
            background: #dddddd;
        }

        .allocations.draghover {
            outline: none;
            box-shadow: 0 0 0 1px #fff, 0 0 0 3px #68b;
        }

    </style>
{% endblock %}

{% block content %}
    <br/><br/>
    <div class="row">
        <div class="col-sm-9">
            <table class="display striped hover" id="rebalance-table">
                <thead>
                <tr>
                    <th>Symbols</th>
                    <th>Desired %</th>
                    <th>Current %</th>
                    <th>Desired $</th>
                    <th>Current $</th>
                    <th><font color="green">Buy</font>/<font color="red">Sell</font></th>
                </tr>
                </thead>
                <tbody>
                {% for alloc in allocs %}
                    <tr>
                        <td id="{{ alloc.id }}" class="allocation">
                            {% for security in alloc.securities.all %}
                                <span class="security" id="{{ security.symbol }}">
                                {{ security }}
                            </span>
                            {% endfor %}
                        </td>
                        <td>
                            <input type="number" value="{{alloc.desired_pct}}" min="0" max="100" width="40" step="0.1" id="{{ alloc.id }}-desired_pct" />
                        </td>
                        <td id="{{ alloc.id }}-current_pct">{{alloc.current_pct | floatformat:1}}%</td>
                        <td id="{{ alloc.id }}-desired_amt">{{alloc.desired_amt | currencyround}}</td>
                        <td id="{{ alloc.id }}-current_amt">{{alloc.current_amt | currencyround}}</td>
                        <td id="{{ alloc.id }}-buysell">{{alloc.buysell | currencyround | colorize}}</td>
                    </tr>
                {% endfor %}
                {% if leftover %}
                    <tr id="row-{{ alloc.leftover }}">
                        <td class="allocation">
                            {% for security in leftover.securities %}
                                <span class="security" id="{{ security.symbol }}">
                                    {{ security }}
                                </span>
                            {% endfor %}
                        </td>
                        <td>{{ leftover.desired_pct | floatformat:1 }}% (Inferred)</td>
                        <td>{{ leftover.current_pct | floatformat:1 }}%</td>
                        <td>{{ leftover.desired_amt | currencyround }}</td>
                        <td>{{ leftover.current_amt | currencyround }}</td>
                        <td>{{ leftover.buysell | currencyround | colorize }}</td>
                    </tr>
                {% endif %}
                <tr>
                    <td class="allocation" id="new"></td>
                    <td>New</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                </tbody>
            </table>

        </div>
        <div class="col-sm-2">
            <div class="form-group">
                <form action="" id="date-submit-form" method="get">
                    <label for="cashadd">Additional cash to invest:</label>
                    <input type="number" class="form-control" required id="cashadd" name="cashadd"
                           placeholder="{{ cashadd }}">
                    <button type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}

{% block footer_javascript_page %}
    <script>
        var table;
        $(document).ready(function () {
            table = $('#rebalance-table').DataTable({
                columns: [
                    {data: 'Symbols'},
                    {data: 'Desired_P'},
                    {data: 'Current_P'},
                    {data: 'Desired_D'},
                    {data: 'Current_D'},
                    {data: 'BuySell'},
                ],
                order: [[1, 'desc']],
                paging: false,
                searching: false,
            });
        });

        $(function () {
            $(".allocation").sortable({
                connectWith: ".allocation",
                receive: function (event, ui) {
                    $.ajax({
                        url: window.location.pathname,
                        data: {
                            source_alloc: ui.sender.attr('id'),
                            security: ui.item.attr('id'),
                            target_alloc: event.target.id
                        },
                        context: this,
                        success: function (data) {
                            $.each($.parseHTML(data), function (i, elem) {
                                if (elem.nodeName == "TD") {
                                    table.row.remove()
                                    cell = document.getElementById(elem.id);
                                    $(cell).html($(elem).html());
                                }
                            });
                        },
                        error: function (data) {
                            alert("Couldn't modify allocation!\n" + data["responseText"]);
                        },
                        complete: function (jqXHR, textStatus) {
                        }
                    });
                }
            }).disableSelection();
        });

    </script>
{% endblock %}
