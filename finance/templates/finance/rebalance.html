{% extends "base.html" %}
{% load mytags %}
{% load static %}
{% block title %}Rebalancing Table{% endblock title %}

{% block head_css_page %}
    <style>
        .security {
            border: 1px solid #aaaaaa;
            border-radius: 5px;
            margin: 5px;
            padding: 5px;
            transition-duration: 0.3s;
            transition-property: background-color;
        }

        .security:hover {
            background: #afafaf;
            color: #dddddd;
        }

        .allocation {
            border: 2px solid #aaaaaa;
            margin: 5px;
            padding: 5px;
        }

        .allocation.validtarget {
            border-color: #50e7e9;
            background: #dddddd;
        }

        .allocations.draghover {
            outline: none;
            box-shadow: 0 0 0 1px #fff, 0 0 0 3px #68b;
        }

    </style>
{% endblock %}

{% block content %}
    <br/><br/>
    <div class="row">
        <div class="col-sm-9">
            <table class="display striped hover" id="rebalance-table">
                <thead>
                <tr>
                    <th>Symbols</th>
                    <th>Desired %</th>
                    <th>Current %</th>
                    <th>Desired $</th>
                    <th>Current $</th>
                    <th><font color="green">Buy</font>/<font color="red">Sell</font></th>
                </tr>
                </thead>
                <tbody>
                {% for alloc in allocs %}
                    <tr id="row-{{ alloc.id }}">
                        <td id="{{ alloc.id }}" class="allocation">
                            {% for security in alloc.securities.all %}
                                <span class="security" id="{{ security.symbol }}">
                                    {{ security }}
                                </span>                            {% endfor %}
                        </td>
                        <td id="{{ alloc.id }}-desired_pct">{{ alloc.desired_pct }}</td>
                        <td id="{{ alloc.id }}-current_pct">{{ alloc.current_pct }}</td>
                        <td id="{{ alloc.id }}-desired_amt">{{ alloc.desired_amt }}</td>
                        <td id="{{ alloc.id }}-current_amt">{{ alloc.current_amt }}</td>
                        <td id="{{ alloc.id }}-buysell">{{ alloc.buysell }}</td>
                    </tr>
                {% endfor %}
                {% if leftover %}
                    <tr id="row-leftover">
                        <td class="allocation">
                            {% for security in leftover.securities %}
                                <span class="security" id="{{ security.symbol }}">
                                    {{ security }}
                                </span>
                            {% endfor %}
                        </td>
                        <td id="leftover-desired_pct">{{ leftover.desired_pct | floatformat:1 }}% (Inferred)</td>
                        <td id="leftover-current_pct">{{ leftover.current_pct | floatformat:1 }}%</td>
                        <td id="leftover-desired_amt">{{ leftover.desired_amt | currencyround }}</td>
                        <td id="leftover-current_amt">{{ leftover.current_amt | currencyround }}</td>
                        <td id="leftover-buysell">{{ leftover.buysell | currencyround | colorize }}</td>
                    </tr>
                {% endif %}
                <tr id="row-newrow">
                    <td class="allocation" id="newrow"></td>
                    <td id="newrow-desired_pct"></td>
                    <td id="newrow-current_pct"></td>
                    <td id="newrow-desired_amt"></td>
                    <td id="newrow-current_amt"></td>
                    <td id="newrow-buysell"></td>
                </tr>
                </tbody>
            </table>

        </div>
        <div class="col-sm-3">
            <h3>Insert a pie chart here.</h3>
        </div>

    </div>
    <div class="row">
        <div class="col-sm-2">
            <div class="form-group">
                <form action="" id="date-submit-form" method="get">
                    <label for="cashadd">Additional cash to invest:</label>
                    <input type="number" class="form-control" required id="cashadd" name="cashadd"
                           placeholder="{{ cashadd }}">
                    <button type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>
    {% csrf_token %}
{% endblock content %}

{% block footer_javascript_page %}
    <script>
        // CSRF Boilerplate
        // TODO: Move this to another include somewhere.
        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        // END CSRF Boilerplate

        var table;
        var newrow_template;

        $(document).ready(function () {
            newrow_template = $('#row-newrow').clone();
            table = $('#rebalance-table').DataTable({
                columns: [
                    {data: 'Symbols'},
                    {
                        data: 'Desired_P',
                        render: function (data, type, row) {
                            num = Math.round(data).toFixed(1);
                            id = row.DT_RowId.split('-')[1];
                            return '<input class="desired-pct" type="number" value="' + num +
                                '" min="0" max="100" width="30" step="0.1" id="' + id + '-desired_pct">';
                        }
                    },
                    {
                        data: 'Current_P',
                        render: function (data, type, row) {
                            return Math.round(data).toFixed(1) + "%";
                        }
                    },
                    {
                        data: 'Desired_D',
                        render: function (data, type, row) {
                            return "$" + Math.round(data).toLocaleString();
                        }
                    },
                    {
                        data: 'Current_D',
                        render: function (data, type, row) {
                            return "$" + Math.round(data).toLocaleString();
                        }
                    },
                    {
                        data: 'BuySell',
                        render: function (data, type, row) {
                            color = data < 0 ? 'green' : 'red';
                            dollars = Math.round(data).toLocaleString();
                            return "<font color=" + color + ">" + dollars + "</font>";
                        }
                    },
                ],
                order: [[1, 'desc']],
                paging: false,
                searching: false,
            });
        });

        function rename_row_ids(row, oldstr, newstr) {
            $(row).children().each(function () {
                var newid = $(this).attr('id').replace(oldstr, newstr);
                $(this).attr('id', newid);
            });
            var newid = $(row).attr('id').replace(oldstr, newstr);
            $(row).attr('id', newid);
        };

        $(function () {
            $(".allocation").sortable({
                connectWith: ".allocation",
                receive: function (event, ui) {
                    if (event.target.id == "newrow") {
                        var row = event.target.parentElement;
                        var newrow = newrow_template.clone();
                        rename_row_ids(row, "newrow", "updaterow");
                        table.row.add(newrow);
                        table.rows("#row-newrow, #row-updaterow").invalidate().draw();
                        console.log(table.rows().ids());
                    }
                    $.ajax({
                        url: window.location.pathname,
                        type: "POST",
                        data: {
                            source_alloc: ui.sender.attr('id'),
                            security: ui.item.attr('id'),
                            target_alloc: event.target.id
                        },
                        context: this,
                        success: function (data) {
                            if ("updaterow" in data) {
                                var row = document.getElementById("row-updaterow");
                                var new_id = data["updaterow"];
                                rename_row_ids(row, "updaterow", new_id);
                                table.row("#row-" + new_id).invalidate("dom");
                            }
                            if ("delete-id" in data) {
                                var id = data["delete-id"];
                                table.row("#row-" + id).remove();
                            }
                            for (id in data["new-cells"]) {
                                var cell = table.cell('#' + id);
                                cell.data(data["new-cells"][id]);
                                cell.invalidate();
                            }
                            table.draw();
                        },
                        error: function (data) {
                            alert("Couldn't modify allocation!\n" + data["responseText"]);
                        },
                        complete: function (jqXHR, textStatus) {
                        }
                    });
                }
            }).disableSelection();
        });

        $("body").on("change ", "input", function () {
            $.ajax({
                url: window.location.pathname,
                type: "POST",
                data: {
                    desired_pct: $(this).val(),
                    alloc_id: this.id.split('-')[0]
                },
                success: function (data) {
                    for (id in data["new-cells"]) {
                        var cell = table.cell('#' + id);
                        cell.data(data["new-cells"][id]);
                        cell.invalidate();
                    }
                    table.draw();
                }
            });
        });

    </script>
{% endblock %}
